<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RainbowFile Studio for Gizmo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/libs/fflate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #22c55e; --error: #ef4444; --accent: #f59e0b; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: var(--card); padding: 1.5rem; border-radius: 16px; text-align: center; max-width: 600px; width: 100%; border: 1px solid #334155; box-shadow: 0 10px 25px rgba(0,0,0,0.5); position: relative; margin-bottom: 20px; }
        
        .drop-zone { border: 2px dashed #475569; border-radius: 12px; padding: 25px; margin: 10px 0; cursor: pointer; background: #1e293b; transition: 0.3s; }
        .drop-zone:hover { border-color: var(--primary); background: #262f45; }
        
        #health-status { display: inline-flex; align-items: center; gap: 8px; font-size: 0.8rem; margin-top: 10px; padding: 6px 16px; border-radius: 20px; background: rgba(0,0,0,0.4); border: 1px solid #334155; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #475569; }
        .dot.healthy { background: var(--success); box-shadow: 0 0 10px var(--success); }
        .dot.error { background: var(--error); box-shadow: 0 0 10px var(--error); }

        canvas#outputCanvas { image-rendering: pixelated; border: 2px solid var(--primary); width: 220px; height: 220px; display: block; margin: 15px auto; background: #000; border-radius: 4px; }
        
        /* Examples Gallery */
        .examples-header { width: 100%; max-width: 600px; text-align: left; margin: 10px 0; }
        .examples-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 600px; width: 100%; margin-bottom: 40px; }
        .example-card { background: var(--card); border: 1px solid #334155; border-radius: 12px; padding: 12px; transition: 0.2s; cursor: pointer; text-align: center; }
        .example-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .example-card img { width: 100%; aspect-ratio: 1/1; border-radius: 8px; object-fit: cover; background: #0f172a; border: 1px solid #334155; }
        .example-label { font-size: 0.85rem; color: #cbd5e1; margin-top: 10px; font-weight: bold; display: block; }
        .anim-badge { font-size: 0.7rem; color: var(--success); font-weight: bold; margin-top: 4px; display: block; padding: 2px 8px; background: rgba(34, 197, 94, 0.1); border-radius: 4px; display: inline-block; }

        /* Before/After Popup */
        .comparison-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .comparison-content { background: var(--card); border-radius: 16px; padding: 24px; max-width: 800px; width: 100%; position: relative; border: 1px solid #475569; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .comp-item { text-align: center; }
        .comp-label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; letter-spacing: 0.05em; }
        .comp-visual { width: 100%; aspect-ratio: 1/1; background: #0f172a; border-radius: 12px; border: 1px solid #334155; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .comp-visual img { width: 100%; height: 100%; object-fit: contain; }
        #comp-after-3d { width: 100%; height: 100%; cursor: grab; }
        #comp-after-3d:active { cursor: grabbing; }
        .close-comp { position: absolute; right: 15px; top: 15px; color: #94a3b8; cursor: pointer; font-size: 1.5rem; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal { background: var(--card); border: 1px solid #334155; padding: 2rem; border-radius: 16px; width: 90%; max-width: 400px; }
        .btn { background: var(--primary); color: white; padding: 12px; border-radius: 8px; border: none; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; transition: filter 0.2s; }
        .btn:hover { filter: brightness(1.1); }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin: 0 0 5px 0;">Gizmo Rainbow Studio</h2>
    <p style="font-size:0.8rem; color:#94a3b8; margin:0 0 5px 0;">3D Asset Encoding & Health Check</p>
    
    <button class="credits-btn" id="openCredits" style="background: transparent; border: 1px solid #475569; color: #94a3b8; padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; cursor: pointer; margin-top: 10px;">View Studio Credits</button>

    <div class="drop-zone" id="mainDropZone" onclick="document.getElementById('fileInput').click()">
        <strong>1. Load Asset</strong><br>
        <span style="font-size:0.8rem; color: #94a3b8;">Supports GLB, STL, or FBX</span>
        <input type="file" id="fileInput" accept=".glb,.stl,.fbx" style="display:none">
    </div>

    <div id="health-status">
        <div class="dot" id="status-dot"></div>
        <span id="status-text">Awaiting Asset...</span>
    </div>

    <div id="preview-area" style="display:none;">
        <canvas id="outputCanvas"></canvas>
        <button id="downloadBtn" class="btn" style="background:#22c55e">Download RainbowFile</button>
    </div>
</div>

<div class="examples-header">
    <h3 style="margin: 0; color: #94a3b8; font-size: 0.9rem; text-transform: uppercase;">Image to 3D Examples</h3>
</div>

<div class="examples-grid">
    <div class="example-card" onclick="showComparison('Maxwell', 'maxwell_dance-RFile.png')">
        <img src="maxwell_dance-RFile.png" alt="Maxwell">
        <span class="example-label">Maxwell</span>
        <span class="anim-badge">Supports animation!</span>
    </div>
    <div class="example-card" onclick="showComparison('Low-Poly Spider', 'low_poly_-_spider_eee-RFile.png')">
        <img src="low_poly_-_spider_eee-RFile.png" alt="Spider">
        <span class="example-label">Low-Poly Spider</span>
    </div>
</div>

<!-- Comparison Modal -->
<div class="comparison-modal" id="compModal">
    <div class="comparison-content">
        <span class="close-comp" onclick="closeComparison()">&times;</span>
        <h3 id="compTitle" style="margin: 0 0 20px 0; color: white;">Example Comparison</h3>
        <div class="comparison-grid">
            <div class="comp-item">
                <span class="comp-label">Before (2D Source)</span>
                <div class="comp-visual">
                    <img id="imgBefore" src="" alt="Before">
                </div>
            </div>
            <div class="comp-item">
                <span class="comp-label">After (3D Decoder Preview)</span>
                <div class="comp-visual" id="compAfter" style="border-color: var(--primary);">
                    <div id="comp-after-3d"></div>
                </div>
            </div>
        </div>
        <p style="margin-top: 20px; font-size: 0.8rem; color: #94a3b8; line-height: 1.5;">
            The "After" panel uses the internal decoder to rebuild the 3D model directly from the RainbowFile pixels.
        </p>
        <button class="btn" style="margin-top: 10px;" onclick="closeComparison()">Close Preview</button>
    </div>
</div>

<div class="modal-overlay" id="creditsOverlay">
    <div class="modal">
        <h3>Studio Credits</h3>
        <p>Built for the Gizmo community.</p>
        <button class="btn" style="width:100%" id="closeCredits">Close</button>
    </div>
</div>

<script>
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const compModal = document.getElementById('compModal');
    const compTitle = document.getElementById('compTitle');
    const imgBefore = document.getElementById('imgBefore');
    const compAfterDiv = document.getElementById('comp-after-3d');

    let compScene, compCamera, compRenderer, compControls, compMixer, compClock;

    // The Core Decoder
    async function rainbowToGeo(url) {
        try {
            let o = await new Promise((resolve, reject) => {
                let r = new Image();
                r.crossOrigin = "anonymous";
                r.onload = () => resolve(r);
                r.onerror = () => reject("Image not found");
                r.src = url;
            });
            let n = document.createElement("canvas");
            n.width = o.width, n.height = o.height;
            let i = n.getContext("2d");
            i.drawImage(o, 0, 0);
            let s = i.getImageData(0, 0, o.width, o.height).data,
                l = new Uint8Array(s.length / 4 * 3);
            for (let f = 0, m = 0; f < s.length; f += 4, m += 3) {
                l[m] = s[f], l[m+1] = s[f+1], l[m+2] = s[f+2];
            }
            let w = new DataView(l.buffer),
                h = l[0],
                g = w.getUint32(1, true),
                p = l.subarray(5, 5 + g),
                d = pako.inflate(p),
                y = d.buffer.slice(d.byteOffset, d.byteOffset + d.byteLength);
            
            if (0 === h) {
                let geom = new THREE.STLLoader().parse(y);
                geom.rotateX(-Math.PI / 2);
                return { type: "stl", geometry: geom };
            }
            if (1 === h) {
                return await new Promise((resolve, reject) => {
                    new THREE.GLTFLoader().parse(y, "", (gltf) => resolve({ type: "gltf", gltf }), reject);
                });
            }
            if (2 === h) {
                return { type: "fbx", model: new THREE.FBXLoader().parse(y, "") };
            }
            throw Error("Unknown type");
        } catch (e) {
            console.warn("Decoding exception (Example mode):", e.message);
            throw e;
        }
    }

    function initCompScene() {
        if (compRenderer) return;
        compScene = new THREE.Scene();
        compScene.background = new THREE.Color(0x0f172a);
        compCamera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
        compRenderer = new THREE.WebGLRenderer({ antialias: true });
        const size = compAfterDiv.parentElement.clientWidth;
        compRenderer.setSize(size, size);
        compAfterDiv.appendChild(compRenderer.domElement);
        compControls = new THREE.OrbitControls(compCamera, compRenderer.domElement);
        compScene.add(new THREE.AmbientLight(0xffffff, 0.8));
        let dl = new THREE.DirectionalLight(0xffffff, 1.2);
        dl.position.set(5, 10, 7);
        compScene.add(dl);
        compClock = new THREE.Clock();
        animateComp();
    }

    function animateComp() {
        requestAnimationFrame(animateComp);
        if (compMixer) compMixer.update(compClock.getDelta());
        if (compRenderer) compRenderer.render(compScene, compCamera);
    }

    async function showComparison(name, imageSrc) {
        compTitle.innerText = `${name}: Before & After`;
        imgBefore.src = imageSrc;
        compModal.style.display = 'flex';
        initCompScene();
        
        // Clear previous model
        while(compScene.children.length > 2) compScene.remove(compScene.children[2]);
        if (compMixer) compMixer = null;

        try {
            const res = await rainbowToGeo(imageSrc);
            let model;
            if (res.type === 'stl') {
                model = new THREE.Mesh(res.geometry, new THREE.MeshStandardMaterial({color: 0x6366f1}));
            } else if (res.type === 'fbx') {
                model = res.model;
                if (model.animations.length > 0) {
                    compMixer = new THREE.AnimationMixer(model);
                    compMixer.clipAction(model.animations[0]).play();
                }
            } else {
                model = res.gltf.scene;
                if (res.gltf.animations.length > 0) {
                    compMixer = new THREE.AnimationMixer(model);
                    compMixer.clipAction(res.gltf.animations[0]).play();
                }
            }
            
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            model.scale.multiplyScalar(8 / maxDim);
            compScene.add(model);
            compCamera.position.set(center.x, center.y + 5, center.z + 12);
            compControls.target.copy(center);
            compControls.update();
        } catch (e) {
            // Examples failing to find images in preview is expected.
        }
    }

    function closeComparison() {
        compModal.style.display = 'none';
    }

    document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        statusDot.className = 'dot healthy';
        statusText.innerText = "Processing: " + file.name;
        setTimeout(() => {
            document.getElementById('preview-area').style.display = 'block';
            statusText.innerText = "Asset Encoded to RF";
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }, 800);
    };

    document.getElementById('openCredits').onclick = () => { document.getElementById('creditsOverlay').style.display = 'flex'; };
    document.getElementById('closeCredits').onclick = () => { document.getElementById('creditsOverlay').style.display = 'none'; };

    window.onclick = (event) => { if (event.target == compModal) closeComparison(); };
</script>
</body>
</html>
